<%# app/views/categories/index.html.erb %>

<div class="bg-white">
  <%# Hero Section %>
  <div class="relative overflow-hidden bg-gradient-to-r from-indigo-600 to-purple-600">
    <div class="absolute inset-0 overflow-hidden">
      <svg class="absolute bottom-0 left-0 right-0 transform translate-y-1/2" viewBox="0 0 1200 120" preserveAspectRatio="none">
        <path fill="rgba(255, 255, 255, 0.05)" d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z"></path>
        <path fill="rgba(255, 255, 255, 0.1)" d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z"></path>
      </svg>
    </div>
    
    <div class="relative max-w-7xl mx-auto py-24 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl font-extrabold tracking-tight text-white sm:text-5xl lg:text-6xl">
          Browse Categories
        </h1>
        <p class="mt-6 max-w-2xl mx-auto text-xl text-indigo-100">
          Explore our curated collection of digital and physical products across diverse categories.
        </p>
      </div>
    </div>
  </div>

  <%# Main Content %>
  <div class="max-w-7xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:px-8">
    <%# Parent Categories %>
    <div class="space-y-16">
      <%# Top-level categories (no parent) %>
      <section>
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Main Categories</h2>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          <% Category.where(parent_id: nil, visible: true).order(:position).each do |category| %>
            <%= link_to category_path(category), class: "group" do %>
              <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 transition duration-300 ease-in-out transform hover:shadow-md hover:-translate-y-1 h-full flex flex-col">
                <%# Category header with icon %>
                <div class="p-6 flex items-center space-x-4">
                  <div class="<%= "bg-#{category.icon_color || 'indigo'}-100" %> p-3 rounded-full">
                    <svg class="h-6 w-6 <%= "text-#{category.icon_color || 'indigo'}-600" %>" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <% case category.icon_name %>
                      <% when "book" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                      <% when "device" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      <% when "home" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                      <% when "shopping" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                      <% when "music" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                      <% when "photo" %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      <% else %>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                      <% end %>
                    </svg>
                  </div>
                  <h3 class="text-lg font-medium text-gray-900 group-hover:text-indigo-600 transition">
                    <%= category.name %>
                  </h3>
                </div>
                
                <%# Category details %>
                <div class="px-6 py-4 flex-1">
                  <p class="text-sm text-gray-500 line-clamp-2">
                    <%= category.description.present? ? category.description : "Browse all products in the #{category.name} category" %>
                  </p>
                </div>
                
                <%# Category stats %>
                <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">
                      <%= pluralize(category.products_count, 'product') %>
                    </span>
                    
                    <% subcategory_count = Category.where(parent_id: category.id, visible: true).count %>
                    <% if subcategory_count > 0 %>
                      <span class="text-sm text-gray-500">
                        <%= pluralize(subcategory_count, 'subcategory') %>
                      </span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </section>
      
      <%# Featured/Popular Categories Section %>
      <% popular_categories = Category.joins(:products).group(:id).order('COUNT(products.id) DESC').limit(3) %>
      <% if popular_categories.any? %>
        <section>
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-gray-900">Popular Categories</h2>
            <a href="#" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
              View all
              <span aria-hidden="true"> &rarr;</span>
            </a>
          </div>
          
          <div class="mt-6 grid grid-cols-1 gap-y-10 gap-x-6 sm:grid-cols-2 lg:grid-cols-3">
            <% popular_categories.each do |category| %>
              <div class="relative group">
                <div class="aspect-w-3 aspect-h-2 rounded-lg overflow-hidden bg-gray-100">
                  <% if category.products.any? && category.products.first.product_images.any? && category.products.first.product_images.first.image.attached? %>
                    <%= image_tag url_for(category.products.first.product_images.first.image),
                                  class: "w-full h-full object-center object-cover group-hover:opacity-75 transition-opacity" %>
                  <% else %>
                    <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-indigo-100 to-indigo-50">
                      <svg class="h-16 w-16 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <% case category.icon_name %>
                        <% when "book" %>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        <% when "device" %>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        <% else %>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        <% end %>
                      </svg>
                    </div>
                  <% end %>
                  <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/70 to-transparent">
                    <h3 class="text-xl font-bold text-white">
                      <%= link_to category.name, category_path(category), class: "hover:underline" %>
                    </h3>
                    <p class="mt-1 text-sm text-white/80">
                      <%= pluralize(category.products_count, 'product') %>
                    </p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>
      
      <%# Recently Updated Categories %>
      <% recent_categories = Category.where(visible: true).order(updated_at: :desc).limit(6) %>
      <section class="bg-gradient-to-r from-gray-50 to-white rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Recently Updated</h2>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
          <% recent_categories.each do |category| %>
            <%= link_to category_path(category), class: "block p-4 rounded-lg hover:bg-white hover:shadow-sm transition duration-200" do %>
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="<%= "bg-#{category.icon_color || 'indigo'}-100" %> p-2 rounded-full">
                    <svg class="h-5 w-5 <%= "text-#{category.icon_color || 'indigo'}-600" %>" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                  </div>
                  <h3 class="text-base font-medium text-gray-900">
                    <%= category.name %>
                  </h3>
                </div>
                <span class="text-sm text-gray-500">
                  <%= category.products_count %> items
                </span>
              </div>
            <% end %>
          <% end %>
        </div>
      </section>
      
      <%# Category Tree %>
      <section>
        <h2 class="text-2xl font-bold text-gray-900 mb-8">All Categories</h2>
        
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
          <ul class="divide-y divide-gray-200">
            <% Category.where(parent_id: nil, visible: true).order(:position).each do |parent_category| %>
              <li>
                <div class="block hover:bg-gray-50"
                      data-controller="collapsible"
                      data-collapsible-collapsed-value="true">
                  <div class="px-4 py-4 sm:px-6">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <div class="<%= "bg-#{parent_category.icon_color || 'indigo'}-100" %> p-2 rounded-full">
                          <svg class="h-5 w-5 <%= "text-#{parent_category.icon_color || 'indigo'}-600" %>" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                          </svg>
                        </div>
                        <p class="ml-3 text-sm font-medium text-gray-900">
                          <%= link_to parent_category.name, category_path(parent_category), class: "hover:text-indigo-600" %>
                        </p>
                      </div>
                      <div class="flex items-center">
                        <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                          <%= pluralize(parent_category.products_count, 'product') %>
                        </p>
                        
                        <% subcategories = Category.where(parent_id: parent_category.id, visible: true) %>
                        <% if subcategories.any? %>
                          <button type="button" 
                                  class="ml-4 p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none"
                                  data-action="collapsible#toggle">
                            <span class="sr-only">Show subcategories</span>
                            <svg class="h-5 w-5 transform transition-transform duration-200" 
                                 data-collapsible-target="icon" 
                                 xmlns="http://www.w3.org/2000/svg" 
                                 viewBox="0 0 20 20" 
                                 fill="currentColor" 
                                 aria-hidden="true">
                              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                          </button>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  
                  <% if subcategories.any? %>
                    <div class="border-t border-gray-200 bg-gray-50 pl-12 hidden" data-collapsible-target="content">
                      <ul class="divide-y divide-gray-200">
                        <% subcategories.order(:position).each do |subcategory| %>
                          <li class="px-4 py-3">
                            <div class="flex items-center justify-between">
                              <div class="flex items-center">
                                <div class="<%= "bg-#{subcategory.icon_color || 'indigo'}-50" %> p-1.5 rounded-full">
                                  <svg class="h-4 w-4 <%= "text-#{subcategory.icon_color || 'indigo'}-600" %>" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                  </svg>
                                </div>
                                <p class="ml-3 text-sm font-medium text-gray-700">
                                  <%= link_to subcategory.name, category_path(subcategory), class: "hover:text-indigo-600" %>
                                </p>
                              </div>
                              <div>
                                <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                  <%= pluralize(subcategory.products_count, 'product') %>
                                </p>
                              </div>
                            </div>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </section>
    </div>
  </div>
</div>

<%# Stimulus Controller for Collapsible Panels %>
<%= javascript_tag do %>
  application.register("collapsible", class extends Stimulus.Controller {
    static targets = ["content", "icon"]
    static values = { collapsed: Boolean }
    
    connect() {
      this.updateUI()
    }
    
    toggle() {
      this.collapsedValue = !this.collapsedValue
      this.updateUI()
    }
    
    updateUI() {
      if (this.collapsedValue) {
        this.contentTarget.classList.add('hidden')
        this.iconTarget.classList.remove('rotate-180')
      } else {
        this.contentTarget.classList.remove('hidden')
        this.iconTarget.classList.add('rotate-180')
      }
    }
  })
<% end %>